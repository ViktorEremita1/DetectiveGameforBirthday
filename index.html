<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–µ—Ç–µ–∫—Ç–∏–≤ –í–∏–∫–∏: –î–µ–ª–æ ‚Ññ2024</title>
    <style>
        :root {
            --burgundy: #4b0013;
            --gold: #d4af37;
            --dark: #121212;
            --light: #f4e7d3;
            --card-w: 160px; 
            --card-h: 240px;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--dark);
            color: var(--light);
            font-family: 'Georgia', serif;
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
            touch-action: none;
        }

        /* --- –ù–£–ê–†–ù–´–ï –≠–§–§–ï–ö–¢–´ --- */
        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.8) 150%);
            pointer-events: none; z-index: 1000;
        }

        .film-grain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.04; pointer-events: none; z-index: 1001;
            background-image: url("https://www.transparenttextures.com/patterns/stardust.png");
            animation: grain 1s steps(10) infinite;
        }
        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-1%, -1%); }
            50% { transform: translate(-0.5%, 0.5%); }
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #2c0008 0%, #121212 100%);
            z-index: 600; display: flex; flex-direction: column;
            justify-content: flex-end; align-items: center; padding-bottom: 50px;
        }
        #start-screen::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://i.postimg.cc/NGZPkK8S/Oblozka.png') no-repeat center center;
            background-size: contain; z-index: -1;
            filter: grayscale(0.3) contrast(1.1);
        }

        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #3d000f 0%, #121212 100%);
            z-index: 500; display: none; flex-direction: column;
            align-items: center; text-align: center; padding: 20px; box-sizing: border-box; overflow-y: auto;
        }

        .intro-text {
            width: 90%; max-width: 850px; text-align: left; line-height: 1.6;
            margin: 20px 0; background: rgba(0,0,0,0.8); padding: 30px;
            border-radius: 4px; border-left: 3px solid var(--gold);
            font-size: 1rem; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .btn-start {
            padding: 15px 40px; background: var(--gold); color: var(--burgundy);
            font-size: 1.1rem; font-weight: bold; border-radius: 2px;
            cursor: pointer; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.3s;
        }

        #status-bar {
            height: 50px; background: var(--gold); color: var(--burgundy);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; font-weight: bold; font-size: 0.85rem; z-index: 300;
        }

        .hint-text { font-size: 0.65rem; opacity: 0.8; margin-left: 10px; font-weight: normal; letter-spacing: 1px; }

        #table-zone {
            position: absolute; top: 50px; left: 0; right: 0; bottom: 320px;
            padding: 30px; overflow-y: auto;
            background: radial-gradient(circle, #3d000f 0%, #1a1a1a 100%);
            display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
            transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .zone-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--gold); opacity: 0.15; font-size: 1.5rem; text-align: center;
            pointer-events: none; width: 80%; text-transform: uppercase; letter-spacing: 2px;
        }

        @keyframes appearWithWobble {
            0% { transform: scale(1.1) rotate(0deg); opacity: 0; }
            100% { transform: rotate(var(--rand-rot)); opacity: 1; }
        }

        .table-card {
            animation: appearWithWobble 0.5s ease-out forwards;
            margin: 5px;
        }
        
        .card {
            width: var(--card-w); height: var(--card-h); background: #eee; padding: 6px;
            border-radius: 2px; position: relative; display: flex; flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6); flex-shrink: 0;
            user-select: none; touch-action: none; cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 45px rgba(0,0,0,0.9);
            z-index: 100;
        }
        .table-card:hover {
            transform: rotate(var(--rand-rot)) scale(1.05) !important;
            z-index: 110;
        }

        #game-controls-wrapper {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 320px;
            z-index: 200; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #game-controls-wrapper.hidden { transform: translateY(320px); }

        #game-controls {
            height: 100%; background: #220008;
            display: grid; grid-template-columns: 140px 1fr 240px;
            align-items: center; padding: 0 15px; border-top: 2px solid var(--gold);
        }

        #toggle-view-btn {
            position: absolute; top: -40px; right: 30px;
            background: var(--gold); color: var(--burgundy);
            border: none; padding: 8px 25px; font-weight: bold;
            border-radius: 4px 4px 0 0; cursor: pointer;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5); font-family: 'Georgia', serif; font-size: 0.85rem;
        }

        .pile-container { 
            display: flex; flex-direction: column; align-items: center; 
            color: var(--gold); font-size: 0.75rem; height: 280px; justify-content: center;
            text-transform: uppercase; letter-spacing: 1px;
            position: relative;
        }
        
        .archive-hint {
            font-size: 0.7rem; color: var(--gold); margin-top: 10px; text-align: center; 
            max-width: 200px; line-height: 1.3; pointer-events: none; font-weight: bold;
            border: 2px solid var(--gold); padding: 10px; border-radius: 6px; 
            background: rgba(75, 0, 19, 0.6); box-shadow: 0 0 15px rgba(0,0,0,0.5);
            letter-spacing: 0.5px;
        }

        #deck-visual, #archive-visual { position: relative; width: 90px; height: 135px; margin: 10px auto; }
        
        #progress-mini-container {
            width: 160px; margin-top: 15px; text-align: center;
        }
        #progress-mini-bar-bg {
            width: 100%; height: 6px; background: rgba(212, 175, 55, 0.1);
            border-radius: 3px; overflow: hidden; margin-top: 6px; border: 1px solid rgba(212, 175, 55, 0.3);
        }
        #progress-mini-bar-fill {
            width: 10%; height: 100%; background: var(--gold);
            box-shadow: 0 0 10px var(--gold); transition: width 0.5s ease;
        }
        .mini-label { font-size: 0.7rem; font-weight: bold; letter-spacing: 1px; }

        .card-back {
            width: 90px; height: 135px; background-size: 100% 100%;
            border-radius: 4px; position: absolute; filter: brightness(0.8);
            box-shadow: -2px 2px 5px rgba(0,0,0,0.4);
        }

        #hand-zone { display: flex; justify-content: center; gap: 20px; width: 100%; height: 100%; align-items: center; }

        .card.dragging { cursor: grabbing; z-index: 1000; opacity: 0.9; box-shadow: 0 20px 40px rgba(0,0,0,0.8); transform: scale(1.05); }
        .card img { width: 100%; height: 100%; object-fit: cover; filter: sepia(0.2) contrast(1.1); pointer-events: none; }
        
        .card-cost {
            position: absolute; top: -12px; right: -12px; background: var(--gold);
            color: var(--burgundy); width: 32px; height: 32px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-weight: bold;
            border: 2px solid var(--burgundy); z-index: 10; font-size: 1.1rem; pointer-events: none;
        }

        .final-box {
            background: rgba(10,0,5,0.98); padding: 20px; border: 1px solid var(--gold);
            text-align: center; width: 95%; max-width: 750px; color: var(--light);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            max-height: 280px; display: flex; flex-direction: column;
        }
        .final-content {
            overflow-y: auto; padding-right: 15px; margin-bottom: 15px;
            scrollbar-width: thin; scrollbar-color: var(--gold) transparent;
        }
        .final-content::-webkit-scrollbar { width: 4px; }
        .final-content::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 2px; }

        #zoom-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center;
        }
        #zoom-overlay img { max-width: 85%; max-height: 85%; border: 1px solid var(--gold); }
        
        .flying-card {
            position: fixed; pointer-events: none; z-index: 9999;
            background-size: 100% 100%; border-radius: 4px;
            transition: all 0.6s cubic-bezier(0.2, 1, 0.3, 1);
        }
        
        .audio-btn { 
            background: var(--burgundy); color: var(--gold); border: 1px solid var(--gold); 
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;
            min-width: 90px; font-weight: bold;
        }
        input[type=range] { cursor: pointer; width: 50px; accent-color: var(--burgundy); }
    </style>
</head>
<body>

<div class="film-grain"></div>

<div id="start-screen">
    <button class="btn-start" onclick="initGame()">–ù–∞—á–∞—Ç—å</button>
</div>

<div id="intro-screen">
    <h1 style="color: var(--gold); letter-spacing: 5px;">–î–ï–¢–ï–ö–¢–ò–í –í–ò–ö–ò</h1>
    <div class="intro-text">
        –ù–∞ —á–∞—Å–∞—Ö 23:50. –ü—è—Ç—å –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥ –†–æ–º–∞—Ä–∏–æ –∑–∞–ø–µ—Ä –≤—Å–µ –¥–≤–µ—Ä–∏ –∑–∞–≥–æ—Ä–æ–¥–Ω–æ–≥–æ –æ—Å–æ–±–Ω—è–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã –æ—Ç–º–µ—á–∞–ª–∏ —Ç–≤–æ–π –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –∏ –ø–æ–ø—Ä–æ—Å–∏–ª –≤—Å–µ—Ö —Å–æ–±—Ä–∞—Ç—å—Å—è –≤ –≥–æ—Å—Ç–∏–Ω–æ–π. –û–Ω –ø–æ–¥–æ—à–µ–ª –∫ —Ç–µ–±–µ, —Å–≤–æ–µ–π –∂–µ–Ω–µ, –∏ —Å–∫–∞–∑–∞–ª: ¬´–ü–æ–¥–∞—Ä–æ–∫ –ø—Ä–æ–ø–∞–ª. –Ø –±–æ—é—Å—å, —á—Ç–æ –µ–≥–æ —É–∫—Ä–∞–ª–∏. –ù–∏–∫–æ–º—É –Ω–µ –º–æ–≥—É –¥–æ–≤–µ—Ä—è—Ç—å, –¥–∞–∂–µ —Å–µ–±–µ. –ë–æ—é—Å—å, –ø—Ä–∏–¥–µ—Ç—Å—è —Ç–µ–±–µ –ø—Ä–µ—Ä–≤–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫ –∏ –Ω–∞–π—Ç–∏ –µ–≥–æ¬ª. <br><br>
        –í —ç—Ç–æ—Ç –¥–µ–Ω—å —á—Ç–æ-—Ç–æ –¥–æ–ª–∂–Ω–æ –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫. –¢—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ –∫–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö —Ö—Ä–∞–Ω–∏—Ç —Å–≤–æ–∏ —Ç–∞–π–Ω—ã, –æ–ø–∞—Å–Ω—ã–µ —Ç–∞–π–Ω—ã, –Ω–æ –ø–æ—á–µ–º—É —Ö–æ—Ç—è –±—ã —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –Ω–µ –º–æ–≥–ª–æ –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–π. –ù–æ –æ–Ω–∏ –∏ –Ω–µ –¥–æ–≥–∞–¥—ã–≤–∞—é—Ç—Å—è –æ —Ç–≤–æ–µ–π —Ç–∞–π–Ω–µ. –ß—Ç–æ –∂, –ø—É—Å—Ç—å —ç—Ç–æ—Ç –≤–µ—á–µ—Ä —Å—Ç–∞–Ω–µ—Ç –¥–Ω–µ–º, –∫–æ–≥–¥–∞ –ø–æ–∫—Ä–æ–≤ —Ç–∞–π–Ω—ã –±—É–¥–µ—Ç —Å–æ—Ä–≤–∞–Ω —Å –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –∏ —Ç—ã —Å—Ç–∞–Ω–µ—à—å –ø–µ—Ä–≤–æ–π. <br><br>
        –í—Å–µ –∑–Ω–∞—é—Ç, —á—Ç–æ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å —É—Å–ø–µ—à–Ω—ã–º –º–µ–¥–∏–∞-–∞–Ω–∞–ª–∏—Ç–∏–∫–æ–º, –Ω–æ –Ω–∏–∫—Ç–æ –∏ –Ω–µ –¥–æ–≥–∞–¥—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –ª–∏—à—å –ø—Ä–∏–∫—Ä—ã—Ç–∏–µ. –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Ç–≤–æ–π –Ω–∞—á–∞–ª—å–Ω–∏–∫ ‚Äî —ç—Ç–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∞ —Ç—ã ‚Äî –∞–≥–µ–Ω—Ç —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–Ω—Ç—Ä—Ä–∞–∑–≤–µ–¥–∫–∏. –ü–æ–∂–∞–ª—É–π, —Ç—ã –±–æ–ª—å—à–µ –Ω–µ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —ç—Ç–æ –±—ã–ª–æ —Ç–∞–π–Ω–æ–π –¥–ª—è —Ç–≤–æ–∏—Ö –ª—É—á—à–∏—Ö –¥—Ä—É–∑–µ–π. –¢—ã —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –æ–± —ç—Ç–æ–º. <br><br>
        –ü—Ä–∏ —ç—Ç–∏—Ö —Å–ª–æ–≤–∞—Ö –∫–∞–∂–¥—ã–π –∏–∑ –≥–æ—Å—Ç–µ–π, –∏ –¥–∞–∂–µ —Ç–≤–æ–π –º—É–∂ –†–æ–º–∞—Ä–∏–æ, –∑–∞–º–µ—Ç–Ω–æ –∑–∞–±–µ—Å–ø–æ–∫–æ–∏–ª–∏—Å—å. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –∏—Ö –≥–æ–ª–æ–≤–∞—Ö? –ö–∞–∫–∏–µ —Å–µ–∫—Ä–µ—Ç—ã —Ç–∞–º —Ö—Ä–∞–Ω—è—Ç—Å—è? –ò —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ, –∫—Ç–æ –ø–æ—Ö–∏—Ç–∏–ª —Ç–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫? –°—É–º–µ–µ—à—å –ª–∏ —Ç—ã –Ω–∞–π—Ç–∏ –µ–≥–æ? –ò —Å–∫–æ–ª—å–∫–æ —á—É–∂–∏—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –ø—Ä–∏ —ç—Ç–æ–º –≤—Å–∫—Ä–æ–µ—Ç—Å—è? <br><br>
        –ü—Ä–µ–∂–¥–µ —á–µ–º —Ç—ã –Ω–∞—á–Ω–µ—à—å, –ø–æ–º–Ω–∏, —á—Ç–æ –∫–∞–∂–¥–∞—è —É–ª–∏–∫–∞ –∏–º–µ–µ—Ç —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å, –Ω–æ –Ω–µ –∫–∞–∂–¥–∞—è –∏–∑ –Ω–∏—Ö –ø–æ–≤–µ–¥–µ—Ç —Ç–µ–±—è –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø—É—Ç–∏. –í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ç—ã —Å–º–æ–∂–µ—à—å —É–±–∏—Ä–∞—Ç—å –∫–∞—Ä—Ç—ã –≤ –∞—Ä—Ö–∏–≤. –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç —Ç—ã —É–±—Ä–∞–ª–∞, —Ç—ã —Å–º–æ–∂–µ—à—å –≤—ã–∫–ª–∞–¥—ã–≤–∞—Ç—å –±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º—ã–µ —É–ª–∏–∫–∏. –¶–µ–Ω–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–π —É–ª–∏–∫–∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∞ –≤ —É–≥–ª—É –ø–æ–¥ –ª—É–ø–æ–π. –ß—Ç–æ–±—ã –≤—ã–ª–æ–∂–∏—Ç—å —Å–∞–º—É—é —Ü–µ–Ω–Ω—É—é —É–ª–∏–∫—É, —Ç–µ–±–µ –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ –∞—Ä—Ö–∏–≤ 10 —É–ª–∏–∫. <br><br>
        –£–¥–∞—á–∏ –≤ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏!
    </div>
    <button class="btn-start" onclick="startGame()">–ö —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é</button>
</div>

<div id="status-bar">
    <div>
        <span>–ú–ê–¢–ï–†–ò–ê–õ–´ –î–ï–õ–ê</span>
        <span class="hint-text">(–ù–ê–ñ–ú–ò –î–õ–Ø –£–í–ï–õ–ò–ß–ï–ù–ò–Ø)</span>
    </div>
    <div class="audio-controls">
        <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeVolume(this.value)">
        <button id="music-toggle" class="audio-btn" onclick="toggleMusic()">–ú–£–ó–´–ö–ê: –í–ö–õ</button>
        <button id="sfx-toggle" class="audio-btn" onclick="toggleSfx()">–ó–í–£–ö–ò: –í–ö–õ</button>
    </div>
</div>

<div id="table-zone">
    <div class="zone-hint" id="table-hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∫–∞—Ä—Ç—É —Å—é–¥–∞, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –¥–µ–ª–∞</div>
</div>

<div id="game-controls-wrapper">
    <button id="toggle-view-btn" onclick="toggleControls()">–ü–û–ö–ê–ó–ê–¢–¨ –°–¢–û–õ</button>
    <div id="game-controls">
        <div class="pile-container">
            <span id="deck-count">–ö–û–õ–û–î–ê: 47</span>
            <div id="deck-visual"></div>
        </div>

        <div id="hand-zone"></div>

        <div class="pile-container">
            <div id="archive-visual"></div>
            <div class="archive-hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∫–∞—Ä—Ç—É —Å—é–¥–∞, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤ –∏ —É–≤–µ–ª–∏—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞</div>
            <div id="progress-mini-container">
                <div class="mini-label">–£–†–û–í–ï–ù–¨ –î–û–°–¢–£–ü–ê: <span id="access-level">1</span>/10</div>
                <div id="progress-mini-bar-bg">
                    <div id="progress-mini-bar-fill"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="zoom-overlay" onclick="closeZoom()"><img id="zoomed-img" src=""></div>

<script>
    const musicUrl = "https://www.dropbox.com/scl/fi/gh7ukoms4htc48whcf15o/the-mystery-of-the-old-castle-182681.mp3?rlkey=tqx8vsdxpsv52ziff6nq1enj0&st=i65f08yk&raw=1";
    const sfxUrl = "https://www.dropbox.com/scl/fi/6aw9ocf0uynv6y7jvs0cb/flipcard-91468.mp3?rlkey=9t64yzbe15fbq9wdppkxuitlc&st=zzn6hibe&raw=1";

    const bgMusic = new Audio(musicUrl);
    bgMusic.loop = true;
    bgMusic.volume = 0.3;

    const sfxPool = Array.from({length: 5}, () => new Audio(sfxUrl));
    let currentSfxIdx = 0, isMusicMuted = false, isSfxMuted = false;

    function initGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('intro-screen').style.display = 'flex';
        bgMusic.play().catch(() => {});
    }

    function toggleMusic() {
        isMusicMuted = !isMusicMuted;
        bgMusic.muted = isMusicMuted;
        document.getElementById('music-toggle').innerText = isMusicMuted ? "–ú–£–ó–´–ö–ê: –í–´–ö–õ" : "–ú–£–ó–´–ö–ê: –í–ö–õ";
    }

    function changeVolume(v) {
        bgMusic.volume = v;
    }

    function toggleSfx() {
        isSfxMuted = !isSfxMuted;
        document.getElementById('sfx-toggle').innerText = isSfxMuted ? "–ó–í–£–ö–ò: –í–´–ö–õ" : "–ó–í–£–ö–ò: –í–ö–õ";
    }

    function playSfx() {
        if (isSfxMuted) return;
        const s = sfxPool[currentSfxIdx];
        s.currentTime = 0;
        s.play().catch(() => {});
        currentSfxIdx = (currentSfxIdx + 1) % sfxPool.length;
    }

    const cardBackUrl = "https://i.postimg.cc/Qx5Y4jSR/Rubaska2.png";
    const realCardData = [
        { id: 1, img: "https://i.postimg.cc/Fs2G3w42/1.png", cost: 1 },
        { id: 2, img: "https://i.postimg.cc/dtznrgYf/2.png", cost: 1 },
        { id: 3, img: "https://i.postimg.cc/Hsf3XFgh/3.png", cost: 2 },
        { id: 4, img: "https://i.postimg.cc/15LMwbQ2/4.png", cost: 1 },
        { id: 5, img: "https://i.postimg.cc/Bv3gwDt8/5.png", cost: 2 },
        { id: 6, img: "https://i.postimg.cc/gJSHJTsX/6.png", cost: 3 },
        { id: 7, img: "https://i.postimg.cc/ydQydbjt/7.png", cost: 2 },
        { id: 8, img: "https://i.postimg.cc/tJstVNvr/8.png", cost: 2 },
        { id: 9, img: "https://i.postimg.cc/J0S33H9X/9.png", cost: 3 },
        { id: 10, img: "https://i.postimg.cc/J7FQCSGC/10.png", cost: 4 },
        { id: 11, img: "https://i.postimg.cc/7LYB78kQ/11.png", cost: 3 },
        { id: 12, img: "https://i.postimg.cc/y8mG2Gms/12.png", cost: 4 },
        { id: 13, img: "https://i.postimg.cc/vB0L7N4r/13.png", cost: 5 },
        { id: 14, img: "https://i.postimg.cc/rFzY6d9j/14.png", cost: 4 },
        { id: 15, img: "https://i.postimg.cc/3RxN7jGr/15.png", cost: 4 },
        { id: 16, img: "https://i.postimg.cc/tTC922R4/16.png", cost: 6 },
        { id: 17, img: "https://i.postimg.cc/g2pGq3N9/17.png", cost: 5 },
        { id: 18, img: "https://i.postimg.cc/7LC1W6kH/18.png", cost: 5 },
        { id: 19, img: "https://i.postimg.cc/J7F3xLBy/19.png", cost: 6 },
        { id: 20, img: "https://i.postimg.cc/0j0vW1S4/20.png", cost: 7 },
        { id: 21, img: "https://i.postimg.cc/JhrDqBq0/21.png", cost: 6 },
        { id: 22, img: "https://i.postimg.cc/g0K539m3/22.png", cost: 6 },
        { id: 23, img: "https://i.postimg.cc/zX8WvLhM/23.png", cost: 7 },
        { id: 24, img: "https://i.postimg.cc/6p2y8k9n/24.png", cost: 8 },
        { id: 25, img: "https://i.postimg.cc/pTvSg19k/25.png", cost: 7 },
        { id: 26, img: "https://i.postimg.cc/bNfRj7V7/26.png", cost: 7 },
        { id: 27, img: "https://i.postimg.cc/k47tX6Xm/27.png", cost: 8 },
        { id: 28, img: "https://i.postimg.cc/Xv0j0K3q/28.png", cost: 9 },
        { id: 29, img: "https://i.postimg.cc/mD8Z8T8L/29.png", cost: 8 },
        { id: 30, img: "https://i.postimg.cc/hG0fS9Lz/30.png", cost: 8 },
        { id: 31, img: "https://i.postimg.cc/ncC0G0Yp/31.png", cost: 9 },
        { id: 32, img: "https://i.postimg.cc/xT0gWvWz/32.png", cost: 10 },
        { id: 33, img: "https://i.postimg.cc/3N0G0G0G/33.png", cost: 9 },
        { id: 34, img: "https://i.postimg.cc/3N0G0G0G/34.png", cost: 9 },
        { id: 35, img: "https://i.postimg.cc/3N0G0G0G/35.png", cost: 10 },
        { id: 36, img: "https://i.postimg.cc/3N0G0G0G/36.png", cost: 1 },
        { id: 37, img: "https://i.postimg.cc/3N0G0G0G/37.png", cost: 1 },
        { id: 38, img: "https://i.postimg.cc/3N0G0G0G/38.png", cost: 1 },
        { id: 39, img: "https://i.postimg.cc/3N0G0G0G/39.png", cost: 1 },
        { id: 40, img: "https://i.postimg.cc/3N0G0G0G/40.png", cost: 1 },
        { id: 41, img: "https://i.postimg.cc/3N0G0G0G/41.png", cost: 1 },
        { id: 42, img: "https://i.postimg.cc/3N0G0G0G/42.png", cost: 1 },
        { id: 43, img: "https://i.postimg.cc/3N0G0G0G/43.png", cost: 1 },
        { id: 44, img: "https://i.postimg.cc/3N0G0G0G/44.png", cost: 1 },
        { id: 45, img: "https://i.postimg.cc/3N0G0G0G/45.png", cost: 1 },
        { id: 46, img: "https://i.postimg.cc/3N0G0G0G/46.png", cost: 1 },
        { id: 47, img: "https://i.postimg.cc/3N0G0G0G/47.png", cost: 1 }
    ];

    let deck = [], hand = [], table = [], archiveCount = 0;

    function startGame() {
        document.getElementById('intro-screen').style.display = 'none';
        deck = [...realCardData].sort(() => Math.random() - 0.5);
        hand = deck.splice(0, 5);
        updateUI();
    }

    function toggleControls() {
        const wrap = document.getElementById('game-controls-wrapper');
        const btn = document.getElementById('toggle-view-btn');
        wrap.classList.toggle('hidden');
        btn.innerText = wrap.classList.contains('hidden') ? "–ü–û–ö–ê–ó–ê–¢–¨ –†–£–ö–£" : "–ü–û–ö–ê–ó–ê–¢–¨ –°–¢–û–õ";
    }

    function createCardElement(data, isHand = true) {
        const c = document.createElement('div');
        c.className = 'card' + (isHand ? '' : ' table-card');
        if (!isHand) {
            const rot = (Math.random() * 10 - 5) + 'deg';
            c.style.setProperty('--rand-rot', rot);
            c.style.transform = `rotate(${rot})`;
        }
        
        c.innerHTML = `
            <div class="card-cost">üîç${data.cost}</div>
            <img src="${data.img}" onclick="zoomCard('${data.img}')">
        `;

        if (isHand) {
            c.draggable = true;
            c.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('cardId', data.id);
                c.classList.add('dragging');
            });
            c.addEventListener('dragend', () => c.classList.remove('dragging'));
            
            // Touch
            c.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                c.dataset.startX = touch.clientX;
                c.dataset.startY = touch.clientY;
                c.classList.add('dragging');
            }, {passive: true});

            c.addEventListener('touchend', (e) => {
                c.classList.remove('dragging');
                const touch = e.changedTouches[0];
                const tableRect = document.getElementById('table-zone').getBoundingClientRect();
                const archiveRect = document.getElementById('archive-visual').getBoundingClientRect();
                
                if (touch.clientY < tableRect.bottom && touch.clientY > tableRect.top) {
                    playCardById(data.id);
                } else if (touch.clientX > archiveRect.left && touch.clientX < archiveRect.right &&
                           touch.clientY > archiveRect.top && touch.clientY < archiveRect.bottom) {
                    archiveCardById(data.id);
                }
            });
        }
        return c;
    }

    function playCardById(id) {
        const idx = hand.findIndex(c => c.id === id);
        if (idx > -1 && hand[idx].cost <= archiveCount) {
            const card = hand.splice(idx, 1)[0];
            table.push(card);
            playSfx();
            if (deck.length > 0) hand.push(deck.splice(0,1)[0]);
            updateUI();
            checkWin();
        }
    }

    function archiveCardById(id) {
        const idx = hand.findIndex(c => c.id === id);
        if (idx > -1) {
            hand.splice(idx, 1);
            archiveCount++;
            playSfx();
            if (deck.length > 0) hand.push(deck.splice(0,1)[0]);
            updateUI();
        }
    }

    function zoomCard(src) {
        document.getElementById('zoomed-img').src = src;
        document.getElementById('zoom-overlay').style.display = 'flex';
    }

    function closeZoom() { document.getElementById('zoom-overlay').style.display = 'none'; }

    const tableZone = document.getElementById('table-zone');
    tableZone.addEventListener('dragover', (e) => e.preventDefault());
    tableZone.addEventListener('drop', (e) => {
        const id = parseInt(e.dataTransfer.getData('cardId'));
        playCardById(id);
    });

    const archVisual = document.getElementById('archive-visual');
    archVisual.addEventListener('dragover', (e) => e.preventDefault());
    archVisual.addEventListener('drop', (e) => {
        const id = parseInt(e.dataTransfer.getData('cardId'));
        archiveCardById(id);
    });

    function checkWin() {
        if (table.length >= 15) {
            const box = document.createElement('div');
            box.style.position = 'fixed'; box.style.top = '0'; box.style.left = '0';
            box.style.width = '100%'; box.style.height = '100%';
            box.style.backgroundColor = 'rgba(0,0,0,0.9)'; box.style.zIndex = '5000';
            box.style.display = 'flex'; box.style.justifyContent = 'center'; box.style.alignItems = 'center';
            
            box.innerHTML = `
                <div class="final-box">
                    <h2 style="color:var(--gold); margin-top:0;">–†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û</h2>
                    <div class="final-content">
                        <p>–¢—ã —Å–æ–±—Ä–∞–ª–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–ª–∏–∫, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É –≤–µ—á–µ—Ä–∞. –¢–≤–æ–π –º—É–∂, –†–æ–º–∞—Ä–∏–æ, –Ω–µ —Å–ª—É—á–∞–π–Ω–æ –ø–æ—Ç–µ—Ä—è–ª –ø–æ–¥–∞—Ä–æ–∫. –û–Ω —Ö–æ—Ç–µ–ª –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–±—è, —Ç–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –∏ —Ç–≤–æ—é –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç—å. –ù–æ –æ–Ω –∏ –Ω–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–ª, —á—Ç–æ —Ç–≤–æ—è —Ä–∞–±–æ—Ç–∞ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∞–Ω–∞–ª–∏–∑ –º–µ–¥–∏–∞. –¢–≤–æ—è —Ç–∞–π–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞, –∏ —Ç–µ–ø–µ—Ä—å –≤–∞—à–∞ –∂–∏–∑–Ω—å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –ø—Ä–µ–∂–Ω–µ–π. –¢—ã –Ω–∞—à–ª–∞ –ø–æ–¥–∞—Ä–æ–∫, –Ω–æ —Ü–µ–Ω–∞ —ç—Ç–æ–π –Ω–∞—Ö–æ–¥–∫–∏ ‚Äî –ø—Ä–∞–≤–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–º–µ–Ω–∏—Ç –≤—Å—ë.</p>
                    </div>
                    <button class="btn-start" onclick="location.reload()">–ù–ê–ß–ê–¢–¨ –ó–ê–ù–û–í–û</button>
                </div>
            `;
            document.body.appendChild(box);
        }
    }

    function updateUI() {
        const hz = document.getElementById('hand-zone'); hz.innerHTML = '';
        hand.forEach(c => hz.appendChild(createCardElement(c, true)));

        const tz = document.getElementById('table-zone'); 
        const existingTableCards = tz.querySelectorAll('.card').length;
        if (table.length > existingTableCards) {
            for (let i = existingTableCards; i < table.length; i++) {
                tz.appendChild(createCardElement(table[i], false));
            }
        }
        
        document.getElementById('table-hint').style.display = table.length > 0 ? 'none' : 'block';

        const dv = document.getElementById('deck-visual'); dv.innerHTML = '';
        const av = document.getElementById('archive-visual'); av.innerHTML = '';
        const fill = document.getElementById('progress-mini-bar-fill');
        const access = document.getElementById('access-level');
        const percent = Math.min((archiveCount / 10) * 100, 100);
        fill.style.width = percent + '%';
        access.innerText = archiveCount; 
        
        for(let i=0; i<Math.min(deck.length, 5); i++) {
            const b = document.createElement('div'); b.className = 'card-back';
            b.style.left = (i*2)+'px'; b.style.top = -(i*2)+'px';
            b.style.backgroundImage = `url(${cardBackUrl})`; dv.appendChild(b);
        }
        for(let i=0; i<Math.min(archiveCount, 5); i++) {
            const b = document.createElement('div'); b.className = 'card-back';
            b.style.left = (i*2)+'px'; b.style.top = -(i*2)+'px';
            b.style.backgroundImage = `url(${cardBackUrl})`; av.appendChild(b);
        }
        document.getElementById('deck-count').innerText = `–ö–û–õ–û–î–ê: ${deck.length}`;
    }

    window.addEventListener('keydown', (e) => {
        if (e.key === "1") playCard(0); if (e.key === "2") discardToArchive(0);
        if (e.key === "3") playCard(1); if (e.key === "4") discardToArchive(1);
        if (e.key === "5") playCard(2); if (e.key === "6") discardToArchive(2);
        if (e.key === "7") playCard(3); if (e.key === "8") discardToArchive(3);
        if (e.key === "9") playCard(4); if (e.key === "0") discardToArchive(4);
    });

    function playCard(idx) { if (hand[idx]) playCardById(hand[idx].id); }
    function discardToArchive(idx) { if (hand[idx]) archiveCardById(hand[idx].id); }

</script>

</body>
</html>
